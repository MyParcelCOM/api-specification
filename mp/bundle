#!/usr/bin/env bash

echo -e "\033[0;30;47m Bundling spec \033[0m"
${COMPOSE} run --rm bundler bash -c "
json-refs resolve root.json -f > generated/specification.json
"

if [ "$(uname -s)" == "Linux" ]; then
  echo -e "\033[0;30;47m Fixing file ownership for Linux \033[0m"
  ${COMPOSE} run --rm bundler chown -R $(id -u):$(id -g) generated
fi

echo -e "\033[0;30;47m Injecting vars \033[0m"
# Escape "/" characters to avoid conflict with sed.
API_HOST=${API_HOST//\//\\/}
AUTH_HOST=${AUTH_HOST//\//\\/}

${COMPOSE} run --rm bundler bash -c "
sed -i 's/\$API_HOST/${API_HOST}/' generated/specification.json
sed -i 's/\$AUTH_HOST/${AUTH_HOST}/' generated/specification.json
"
